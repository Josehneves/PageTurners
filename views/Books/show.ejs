<%- include('../partials/header') %>

<section id="show-page">
  <div class="bdata">Title:</div>
  <div class="bdata"><%= book.title %></div>
  <div class="bdata">Finished On:</div>
  <div class="bdata"><%= book.finishedOn %></div>
  <div class="bdata">Author:</div>
  <ul>
    <%- book.author.map(a => `
    <li>${a.name}</li>
    ` ) %>
  </ul>
  <!-- end cast list -->
</section>

<h3>Reviews</h3>
<form
  id="add-review-form"
  method="POST"
  action="/books/<%= book._id %>/reviews"
>
  <label>Review:</label>
  <textarea name="content"></textarea>
  <label>Rating:</label>
  <select name="rating">
    <option value="0" selected>0</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
  </select>
  <input type="submit" value="Add Review" />
</form>

<% if (book.reviews.length) { %>
<table>
  <thead>
    <tr>
      <th>User</th>
      <th>Date</th>
      <th>Review</th>
      <th>Rating</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody>
    <% let total = 0 %> <% book.reviews.forEach(function(r) { %> <% total +=
    r.rating %>
    <tr>
      <td class="review-user">
        <img
          alt="avatar"
          src="<%= r.userAvatar %>"
          referrerpolicy="no-referrer"
        /><%= r.userName %>
      </td>
      <td><%= r.createdAt.toLocaleDateString() %></td>
      <td id="reviewContent">
        <%= r.content %> <button id="teggleForm">Edit</button>
      </td>
      <td id="reviewForm" style="display: none">
        <form action="/reviews/<%= r._id %>?_method=PUT" method="POST">
          <input type="text" name="content" value="<%= r.content %>" />
          <button type="submit">Edit</button>
        </form>
      </td>
      <td><%= r.rating %></td>
      <td>
        <% if (user?._id.equals(r.user)) { %>
        <form action="/reviews/<%= r._id %>?_method=DELETE" method="POST">
          <button class="dbt" type="submit">Delete</button>
        </form>
      </td>
      <% } %>
    </tr>
    <% }); %>
    <tr>
      <td colspan="3"></td>
      <td><strong><%= (total / book.reviews.length).toFixed(1) %></strong></td>
    </tr>
  </tbody>
</table>
<% } else { %>
<h5>No Reviews Yet</h5>
<% } %>

<script>
  const reviewForm = document.getElementById("reviewForm");
  const reviewContent = document.getElementById("reviewContent");
  const teggleForm = document.getElementById("teggleForm");
  teggleForm.addEventListener("click", () => {
    if (reviewForm.style.display === "block") {
      reviewForm.style.display = "none";
      reviewContent.style.display = "block";
      return;
    } else {
      reviewForm.style.display = "block";
      reviewContent.style.display = "none";
      return;
    }
  });
</script>

<%- include('../partials/footer') %>